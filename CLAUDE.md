# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Prisma Client Python is a next-generation ORM built on top of Prisma that provides type-safe database access for Python. The project consists of two main components:

1. **Client Generation**: Parses Prisma schema files and generates Python client code using Jinja2 templates
2. **Client API**: A wrapper over the GraphQL API exposed by the Prisma Query Engine

## Development Commands

### Core Development
- `make bootstrap` - Full setup: install dependencies, generate client, setup database
- `make database` - Setup test database from schema
- `make format` - Format Python code with ruff and Prisma schemas
- `make clean` - Clean all generated files and caches

### Testing
- `make test` - Run tests using nox (supports multiple Python versions)
- `nox -s test` - Run tests for all Python versions (3.8-3.12)
- `nox -s test -- <pytest-args>` - Run tests with specific pytest arguments
- `pytest --ignore=databases` - Run tests directly (after setup)

### Code Quality
- `make lint` - Run linting via nox
- `make mypy` - Run mypy type checking via nox
- `make pyright` - Generate client and run pyright type checking
- `make typesafety` - Run both pyright and mypy type safety checks
- `ruff format` - Format Python files
- `ruff check` - Lint Python files

### Documentation
- `make docs` - Build documentation
- `make docs-serve` - Serve documentation locally

### Prisma Operations
- `prisma generate` - Generate Python client from schema
- `prisma db push` - Push schema changes to database
- `prisma format --schema=<path>` - Format Prisma schema files

## Architecture

### Source Structure
- `src/prisma/` - Main package containing generated and core client code
- `src/prisma/generator/` - Code generation logic and Jinja2 templates
- `src/prisma/engine/` - Query engine communication layer
- `src/prisma/cli/` - CLI interface wrapping Prisma CLI
- `pipelines/` - Nox-based build pipelines for testing, linting, etc.
- `tests/` - Test suite (supports multiple Python versions)
- `databases/` - Database-specific test configurations

### Key Generated Files
The following files are generated by the Prisma generator and should not be manually edited:
- `src/prisma/client.py` - Main client class
- `src/prisma/models.py` - Pydantic models for database tables
- `src/prisma/types.py` - Type definitions
- `src/prisma/actions.py` - Database operation methods
- `src/prisma/enums.py` - Enum definitions

### Communication Flow
1. Generator process receives DMMF (Data Model Meta Format) from Prisma via JSON-RPC
2. DMMF is parsed into Pydantic models
3. Jinja2 templates render Python client code
4. Client communicates with Prisma Query Engine via GraphQL over HTTP

## Configuration

### Code Formatting
- Python: Uses ruff with 120 character line length, single quotes
- Prisma schemas: Use `prisma format`
- Pre-commit hooks handle automatic formatting

### Type Checking
- Primary: Pyright (strict mode)
- Secondary: mypy
- Target Python version: 3.9+
- Supports both sync and async client patterns

### Testing
- Framework: pytest with coverage
- Database: SQLite for most tests, with docker-compose for database-specific tests
- Integration tests in `tests/integrations/`
- Nox manages testing across Python 3.8-3.12

## Development Workflow

1. **Setup**: Run `make bootstrap` for full environment setup
2. **Schema Changes**: Modify `schema.prisma` → run `prisma generate` → run tests
3. **Code Changes**: Modify source → run `make format` → run `make lint` → run `make test`
4. **Generator Changes**: Modify templates in `src/prisma/generator/templates/` → test generation

## Important Notes

- The project uses nox for cross-Python-version testing and task management
- Generated files should never be manually edited
- All database operations go through the Prisma Query Engine binary
- Type safety is a core design principle - all APIs must be fully typed